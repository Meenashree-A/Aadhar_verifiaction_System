<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadhaar QR Code Verification</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="static/qr.css">
</head>
<body>
    <h1>Aadhaar QR Code Verification</h1>
    <div id="reader"></div>
    <button onclick="startScanner()">Scan Aadhaar QR Code</button>
    <p id="result"></p>

    <script>
        async function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                async (decodedText) => {
                    console.log("✅ Scanned QR Data:", decodedText);

                    try {
                        let qrDataObject = JSON.parse(decodedText.trim());

                        if (qrDataObject.dob && /^\d{8}$/.test(qrDataObject.dob)) {
                            qrDataObject.dob = `${qrDataObject.dob.substring(0, 2)}-${qrDataObject.dob.substring(2, 4)}-${qrDataObject.dob.substring(4)}`;
                        }

                        let response = await fetch("http://127.0.0.1:8000/scan", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ qr_data: qrDataObject })
                        });

                        if (!response.ok) {
                            let errorData = await response.json();
                            throw new Error(errorData.message || `HTTP ${response.status}`);
                        }

                        let result = await response.json();
                        console.log("✅ Server Response:", result);

                        document.getElementById("result").textContent = result.message;
                        document.getElementById("result").style.color = result.status === "success" ? "green" : "red";

                        if (result.status === "success") {
                            setTimeout(() => {
                                window.location.href = "/faceverification";
                            }, 5000);
                        }

                    } catch (error) {
                        console.error("❌ Fetch Error:", error);
                        document.getElementById("result").textContent = error.message || "❌ Verification Failed!";
                        document.getElementById("result").style.color = "red";
                    }

                    html5QrCode.stop();
                },
                (error) => console.error("QR Scan Error:", error)
            ).catch(err => console.error("Scanner Init Error:", err));
        }
    </script>
</body>
</html>